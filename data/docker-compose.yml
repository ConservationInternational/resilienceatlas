version:  '3.8'
services:
## this is for working with dask; uncomment if needed
#  scheduler:
#    context: ./notebooks
#    dockerfile: Dockerfile
#    #image: daskdev/dask
#    hostname: dask-scheduler
#    ports:
#      - "8786:8786"
#      - "8787:8787"
#    command: ["dask-scheduler"]
#
#  worker:
#    context: ./notebooks
#    dockerfile: Dockerfile
#    #image: daskdev/dask
#    volumes:
#        - ./data:/home/jovyan/work/datasets
#        - ./notebooks:/home/jovyan/work/notebooks
#        - ${LOCAL_MODULES}:/home/jovyan/work/modules
#    hostname: dask-worker
#    command: ["dask-worker", "tcp://scheduler:8786"]
    test-notebooks:
      build:
        context: ./notebooks
        dockerfile: Dockerfile
      volumes:
        - ./data:/home/mambauser/data
        - ./notebooks:/home/mambauser/notebooks
      ports:
        - 8887:8888
      container_name: test_jupyter_notebook

    app:
      container_name: test_streamlit_app
      build:
        context: ./streamlit-app
        dockerfile: Dockerfile
      ports:
        - '8501:8501'
      volumes:
        - './data:/usr/src/app/data:delegated'
        - './streamlit-app:/usr/src/app/project:delegated'
      environment:
        - USER_ID=1000
        - GROUP_ID=1000

    titiler:
      image: ghcr.io/developmentseed/titiler:latest
      container_name: test_titiler
      ports:
        - '8080:8000'
      volumes:
        - './data:/app/data:delegated'
      environment:
        - TITILER_DEBUG=True
        - PORT=8000
        - WORKERS_PER_CORE=1
        # GDAL config
        - CPL_TMPDIR=/tmp
        - GDAL_CACHEMAX=75%
        - GDAL_INGESTED_BYTES_AT_OPEN=32768
        - GDAL_DISABLE_READDIR_ON_OPEN=EMPTY_DIR
        - GDAL_HTTP_MERGE_CONSECUTIVE_RANGES=YES
        - GDAL_HTTP_MULTIPLEX=YES
        - GDAL_HTTP_VERSION=2
        - PYTHONWARNINGS=ignore
        - VSI_CACHE=TRUE
        - VSI_CACHE_SIZE=536870912


