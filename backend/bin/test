#!/bin/bash
set -e

echo "ğŸ”§ Installing dependencies..."
# Check if we can write to Gemfile.lock and fix permissions if needed
if [ ! -w "Gemfile.lock" ]; then
  echo "âš ï¸  Gemfile.lock not writable, attempting to fix permissions..."
  if command -v sudo >/dev/null 2>&1; then
    sudo chmod 664 Gemfile.lock 2>/dev/null || echo "Could not fix Gemfile.lock permissions"
    sudo chown $(whoami):$(whoami) Gemfile.lock 2>/dev/null || echo "Could not fix Gemfile.lock ownership"
  else
    echo "sudo not available, trying to continue anyway..."
  fi
fi

# Ensure tmp directory exists and is writable
echo "ğŸ”§ Setting up tmp directories..."
mkdir -p tmp tmp/cache tmp/pids tmp/sockets tmp/storage 2>/dev/null || true

# Ensure log directory exists and is writable
echo "ğŸ”§ Setting up log directory..."
mkdir -p log 2>/dev/null || true

# Ensure public directories exist and are writable  
mkdir -p public/storage public/uploads public/uploads/cache public/uploads/store downloads storage 2>/dev/null || true

# Fix ownership and permissions for volume-mounted directories (Docker issue)
# When directories are volume-mounted, they retain host permissions which may not match container user
echo "ğŸ”§ Ensuring proper ownership and permissions for upload directories..."
if command -v sudo >/dev/null 2>&1; then
  # In Docker containers, we have sudo and need to fix permissions
  ownership_fixed=true
  permissions_fixed=true
  
  sudo chown -R $(whoami):$(whoami) public/storage public/uploads downloads storage log tmp/storage tmp/cache 2>/dev/null || {
    echo "Could not fix ownership"
    ownership_fixed=false
  }
  
  sudo chmod -R 775 public/storage public/uploads downloads storage log tmp/storage tmp/cache 2>/dev/null || {
    echo "Could not fix permissions"
    permissions_fixed=false
  }
  
  if [ "$ownership_fixed" = true ] && [ "$permissions_fixed" = true ]; then
    echo "âœ… Directory ownership and permissions fixed"
  else
    echo "âš ï¸  Some directory ownership and permissions could not be fixed, but continuing..."
  fi
else
  echo "âš ï¸ sudo not available, attempting permission fix without sudo..."
  chown -R $(whoami):$(whoami) public/storage public/uploads downloads storage log tmp/storage tmp/cache 2>/dev/null || echo "Cannot fix ownership without sudo"
  chmod -R 775 public/storage public/uploads downloads storage log tmp/storage tmp/cache 2>/dev/null || echo "Cannot fix permissions without sudo"
fi

# Specifically fix upload directories for photos
echo "ğŸ”§ Setting up upload directories..."
for upload_dir in public/uploads public/uploads/cache public/uploads/store; do
  if [ ! -d "$upload_dir" ]; then
    echo "Creating upload directory: $upload_dir"
    mkdir -p "$upload_dir" 2>/dev/null || true
  fi
  
  # Ensure upload directories are writable by the current user
  if [ -d "$upload_dir" ] && [ ! -w "$upload_dir" ]; then
    echo "âš ï¸  $upload_dir directory not writable, attempting to fix permissions..."
    if command -v sudo >/dev/null 2>&1; then
      sudo chmod 775 "$upload_dir" 2>/dev/null || echo "Could not fix $upload_dir permissions"
      sudo chown $(whoami):$(whoami) "$upload_dir" 2>/dev/null || echo "Could not fix $upload_dir ownership"
    else
      chmod 775 "$upload_dir" 2>/dev/null || echo "Could not fix $upload_dir permissions without sudo"
    fi
  fi
done

# Ensure the tmp directory is writable by the current user
if [ ! -w "tmp" ] || [ ! -w "tmp/" ]; then
  echo "âš ï¸  tmp directory not writable, attempting to fix permissions..."
  if command -v sudo >/dev/null 2>&1; then
    sudo chmod 775 tmp 2>/dev/null || echo "Could not fix tmp permissions"
    sudo chown $(whoami):$(whoami) tmp 2>/dev/null || echo "Could not fix tmp ownership"
  else
    echo "sudo not available, trying to fix without sudo..."
    chmod 775 tmp 2>/dev/null || echo "Could not fix tmp permissions without sudo"
  fi
fi

# Check and fix other required directories
for dir in public/storage public/uploads public/uploads/cache public/uploads/store downloads storage log tmp/storage tmp/cache; do
  if [ -d "$dir" ] && [ ! -w "$dir" ]; then
    echo "âš ï¸  $dir directory not writable, attempting to fix permissions..."
    if command -v sudo >/dev/null 2>&1; then
      sudo chmod 775 "$dir" 2>/dev/null || echo "Could not fix $dir permissions"
      sudo chown $(whoami):$(whoami) "$dir" 2>/dev/null || echo "Could not fix $dir ownership"
    else
      chmod 775 "$dir" 2>/dev/null || echo "Could not fix $dir permissions without sudo"
    fi
  fi
done

# Test if we can actually write to the tmp directory
echo "ğŸ” Testing directory write permissions..."
if ! echo "test" > tmp/write_test.tmp 2>/dev/null; then
  echo "âŒ Cannot write to tmp directory even after permission fixes"
  echo "Current tmp directory permissions:"
  ls -la tmp/ 2>/dev/null || echo "tmp directory does not exist or is not accessible"
  echo "Current user: $(whoami)"
  echo "Current user groups: $(groups)"
  echo "Attempting to create with current user permissions..."
  rm -f tmp/write_test.tmp 2>/dev/null || true
  # Try to create it fresh with explicit ownership
  mkdir -p tmp 2>/dev/null || true
  touch tmp/write_test.tmp 2>/dev/null || echo "Still cannot create files in tmp"
  
  # If still cannot write, try a different approach
  if [ ! -f tmp/write_test.tmp ]; then
    echo "ğŸ”§ Attempting alternative tmp directory setup..."
    if command -v sudo >/dev/null 2>&1; then
      sudo mkdir -p tmp 2>/dev/null || true
      sudo chown -R $(whoami):$(whoami) tmp 2>/dev/null || true
      sudo chmod -R 775 tmp 2>/dev/null || true
      echo "test" > tmp/write_test.tmp 2>/dev/null || echo "âŒ Alternative setup also failed"
    fi
  fi
else
  rm -f tmp/write_test.tmp 2>/dev/null || true
  echo "âœ… tmp directory is writable"
fi

# Test other critical directories
for dir in public/storage public/uploads/cache downloads log tmp/storage; do
  if [ -d "$dir" ]; then
    if echo "test" > "$dir/write_test.tmp" 2>/dev/null; then
      rm -f "$dir/write_test.tmp" 2>/dev/null || true
      echo "âœ… $dir directory is writable"
    else
      echo "âŒ Cannot write to $dir directory"
      echo "Current $dir directory permissions:"
      ls -la "$dir"/ 2>/dev/null || echo "$dir directory does not exist or is not accessible"
      # Try to fix permissions one more time
      if command -v sudo >/dev/null 2>&1; then
        echo "ğŸ”§ Attempting to fix $dir directory permissions..."
        sudo mkdir -p "$dir" 2>/dev/null || true
        sudo chown -R $(whoami):$(whoami) "$dir" 2>/dev/null || true
        sudo chmod -R 775 "$dir" 2>/dev/null || true
        echo "test" > "$dir/write_test.tmp" 2>/dev/null && rm -f "$dir/write_test.tmp" || echo "âŒ $dir still not writable after fix attempt"
      fi
    fi
  fi
done

# Ensure Rails log file exists and is writable
echo "ğŸ”§ Setting up Rails test.log file..."
if [ ! -f "log/test.log" ]; then
  touch log/test.log 2>/dev/null || {
    echo "âš ï¸  Cannot create log/test.log, attempting with sudo..."
    if command -v sudo >/dev/null 2>&1; then
      sudo touch log/test.log 2>/dev/null || true
      sudo chown $(whoami):$(whoami) log/test.log 2>/dev/null || true
    fi
  }
fi

# Ensure log file is writable
if [ -f "log/test.log" ] && [ ! -w "log/test.log" ]; then
  echo "âš ï¸  log/test.log not writable, fixing permissions..."
  if command -v sudo >/dev/null 2>&1; then
    sudo chmod 664 log/test.log 2>/dev/null || echo "Could not fix log/test.log permissions"
    sudo chown $(whoami):$(whoami) log/test.log 2>/dev/null || echo "Could not fix log/test.log ownership"
  else
    chmod 664 log/test.log 2>/dev/null || echo "Could not fix log/test.log permissions without sudo"
  fi
fi

if [ -f "log/test.log" ] && [ -w "log/test.log" ]; then
  echo "âœ… Rails test.log file is writable"
else
  echo "âš ï¸  Rails test.log file may not be accessible, but continuing..."
fi

# Try bundle install, but don't fail if gems are already satisfied
if ! bundle check >/dev/null 2>&1; then
  echo "Dependencies not satisfied, running bundle install..."
  bundle install || {
    echo "âŒ Bundle install failed. Checking permissions..."
    ls -la Gemfile.lock
    echo "Current user: $(whoami)"
    echo "Gem home: ${GEM_HOME:-unset}"
    echo "Bundle path: $(bundle config get path 2>/dev/null || echo 'unset')"
    exit 1
  }
else
  echo "Dependencies already satisfied, skipping bundle install"
fi

case "${1:-all}" in
  "rspec"|"specs"|"tests")
    echo "ğŸ§ª Running RSpec tests..."
    bundle exec rspec "${@:2}"
    ;;
  "rspec-no-system"|"specs-no-system"|"tests-no-system")
    echo "ğŸ§ª Running RSpec tests (excluding system tests)..."
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb" "${@:2}"
    ;;
  "system"|"system-tests")
    echo "ğŸ§ª Running system tests only..."
    echo "ğŸ” Pre-flight checks..."
    
    # Check Chrome wrapper
    echo "Testing Chrome wrapper:"
    if [ -f "/app/chrome_wrapper.sh" ]; then
      echo "âœ… Chrome wrapper found at /app/chrome_wrapper.sh"
      ls -la /app/chrome_wrapper.sh
      
      # Test wrapper directly
      echo "Testing wrapper execution:"
      if timeout 30 /app/chrome_wrapper.sh --version > /tmp/wrapper-test.log 2>&1; then
        echo "âœ… Chrome wrapper test succeeded"
        cat /tmp/wrapper-test.log
      else
        echo "âŒ Chrome wrapper test failed"
        cat /tmp/wrapper-test.log || echo "No log available"
      fi
    else
      echo "âŒ Chrome wrapper not found at /app/chrome_wrapper.sh"
    fi
    
    # Check DISPLAY and Xvfb
    echo "DISPLAY environment: $DISPLAY"
    if [ "$DISPLAY" = ":99" ]; then
      echo "Checking Xvfb on display :99"
      if pgrep -x "Xvfb" > /dev/null; then
        echo "âœ… Xvfb is already running"
      else
        echo "Starting Xvfb for display :99"
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 3
        if pgrep -x "Xvfb" > /dev/null; then
          echo "âœ… Xvfb started successfully"
        else
          echo "âŒ Failed to start Xvfb"
        fi
      fi
    fi
    
    # Clear any old chrome logs
    rm -rf /tmp/chrome-logs
    mkdir -p /tmp/chrome-logs
    
    echo "ğŸ§ª Starting system tests..."
    # If specific files are provided as additional arguments, run those; otherwise run all system tests
    if [ $# -gt 1 ]; then
      echo "Running specific system tests: ${@:2}"
      bundle exec rspec --format documentation "${@:2}"
    else
      echo "Running all system tests in spec/systems/"
      bundle exec rspec spec/systems/ --format documentation
    fi
    ;;
  "system-force"|"system-tests-force")
    echo "ğŸ§ª Running system tests (forced, ignoring Chrome check)..."
    # Clear any old chrome logs
    rm -rf /tmp/chrome-logs
    mkdir -p /tmp/chrome-logs
    
    bundle exec rspec spec/systems/ --format documentation "${@:2}"
    ;;
  "verify-chrome"|"chrome-check")
    echo "ğŸ” Checking Chrome installation..."
    echo "Chrome version:"
    google-chrome --version || echo "âŒ Chrome not found"
    echo "Chrome location:"
    which google-chrome || echo "âŒ Chrome not in PATH"
    echo "Chrome wrapper:"
    ls -la chrome_wrapper.sh || echo "âŒ Chrome wrapper not found"
    echo "Xvfb test:"
    Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    XVFB_PID=$!
    sleep 2
    if ps -p $XVFB_PID > /dev/null; then
      echo "âœ… Xvfb started successfully"
      echo "Testing Chrome wrapper with Xvfb:"
      DISPLAY=:99 timeout 30 ./chrome_wrapper.sh --version --headless > /dev/null 2>&1 && echo "âœ… Chrome wrapper works" || echo "âŒ Chrome wrapper failed"
      kill $XVFB_PID
    else
      echo "âŒ Xvfb failed to start"
    fi
    ;;
  "lint"|"linting")
    echo "ğŸ” Running StandardRB linting..."
    bundle exec standardrb "${@:2}"
    ;;
  "security"|"brakeman")
    echo "ğŸ”’ Running Brakeman security analysis..."
    bundle exec brakeman "${@:2}"
    ;;
  "audit")
    echo "ğŸ›¡ï¸ Running Bundle Audit..."
    bundle exec bundle-audit check --update
    ;;
  "junit")
    echo "ğŸ§ª Running RSpec tests with JUnit output..."
    # Ensure rspec.xml can be created and is writable
    touch tmp/rspec.xml 2>/dev/null || {
      echo "âš ï¸  Cannot create tmp/rspec.xml, checking permissions..."
      ls -la tmp/ 2>/dev/null || echo "tmp directory missing"
      # Try to create it with explicit permissions
      if [ -d tmp ]; then
        rm -f tmp/rspec.xml 2>/dev/null || true
        echo "test" > tmp/rspec.xml 2>/dev/null && rm -f tmp/rspec.xml || {
          echo "âŒ Still cannot write to tmp/rspec.xml"
          echo "Attempting to fix directory permissions..."
          chmod 755 tmp 2>/dev/null || echo "Cannot chmod tmp directory"
          touch tmp/rspec.xml 2>/dev/null || echo "Still cannot create rspec.xml after chmod"
        }
      fi
    }
    bundle exec rspec --format RspecJunitFormatter --out tmp/rspec.xml --format progress "${@:2}"
    ;;
  "junit-no-system")
    echo "ğŸ§ª Running RSpec tests (excluding system tests) with JUnit output..."
    # Ensure rspec.xml can be created and is writable
    touch tmp/rspec.xml 2>/dev/null || {
      echo "âš ï¸  Cannot create tmp/rspec.xml, checking permissions..."
      ls -la tmp/ 2>/dev/null || echo "tmp directory missing"
      # Try to create it with explicit permissions
      if [ -d tmp ]; then
        rm -f tmp/rspec.xml 2>/dev/null || true
        echo "test" > tmp/rspec.xml 2>/dev/null && rm -f tmp/rspec.xml || {
          echo "âŒ Still cannot write to tmp/rspec.xml"
          echo "Attempting to fix directory permissions..."
          chmod 755 tmp 2>/dev/null || echo "Cannot chmod tmp directory"
          touch tmp/rspec.xml 2>/dev/null || echo "Still cannot create rspec.xml after chmod"
        }
      fi
    }
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb" --format RspecJunitFormatter --out tmp/rspec.xml --format progress "${@:2}"
    ;;
  "all")
    echo "ğŸš€ Running all backend tests..."
    echo "ğŸ“ Running linting..."
    bundle exec standardrb
    echo "ğŸ”’ Running security analysis..."
    bundle exec brakeman
    echo "ğŸ›¡ï¸ Running audit..."
    bundle exec bundle-audit check --update
    echo "ğŸ§ª Running tests..."
    bundle exec rspec
    echo "âœ… All backend tests completed!"
    ;;
  "all-no-system")
    echo "ğŸš€ Running all backend tests (excluding system tests)..."
    echo "ğŸ“ Running linting..."
    bundle exec standardrb
    echo "ğŸ”’ Running security analysis..."
    bundle exec brakeman
    echo "ğŸ›¡ï¸ Running audit..."
    bundle exec bundle-audit check --update
    echo "ğŸ§ª Running tests (excluding system tests)..."
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb"
    echo "âœ… All backend tests completed!"
    ;;
  "help"|"--help"|"-h")
    echo "Backend Test Runner"
    echo ""
    echo "Usage: ./bin/test [command] [options]"
    echo ""
    echo "Commands:"
    echo "  rspec, specs, tests      Run RSpec tests"
    echo "  rspec-no-system          Run RSpec tests excluding system tests"
    echo "  system, system-tests     Run system tests only (with Chrome check)"
    echo "  system-force             Run system tests (skip Chrome check)"
    echo "  verify-chrome, chrome-check  Verify Chrome installation"
    echo "  lint, linting           Run StandardRB linting"
    echo "  security, brakeman      Run Brakeman security analysis"
    echo "  audit                   Run Bundle Audit"
    echo "  junit                   Run RSpec with JUnit XML output"
    echo "  junit-no-system         Run RSpec (no system) with JUnit XML output"
    echo "  all                     Run all tests (default)"
    echo "  all-no-system           Run all tests excluding system tests"
    echo "  help                    Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./bin/test                           # Run all tests"
    echo "  ./bin/test all-no-system             # Run all tests except browser tests"
    echo "  ./bin/test rspec                     # Run all RSpec tests"
    echo "  ./bin/test rspec-no-system           # Run RSpec tests without browser tests"
    echo "  ./bin/test system                    # Run system/browser tests only"
    echo "  ./bin/test rspec spec/models/        # Run specific test directory"
    echo "  ./bin/test lint                      # Run linting only"
    echo "  ./bin/test security                  # Run security analysis only"
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo "Run './bin/test help' for usage information"
    exit 1
    ;;
esac
