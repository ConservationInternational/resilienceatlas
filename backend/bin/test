#!/bin/bash
set -e

echo "ğŸ”§ Installing dependencies..."
# Check if we can write to Gemfile.lock and fix permissions if needed
if [ ! -w "Gemfile.lock" ]; then
  echo "âš ï¸  Gemfile.lock not writable, attempting to fix permissions..."
  if command -v sudo >/dev/null 2>&1; then
    sudo chmod 664 Gemfile.lock 2>/dev/null || echo "Could not fix Gemfile.lock permissions"
  else
    echo "sudo not available, trying to continue anyway..."
  fi
fi

# Try bundle install, but don't fail if gems are already satisfied
if ! bundle check >/dev/null 2>&1; then
  echo "Dependencies not satisfied, running bundle install..."
  bundle install
else
  echo "Dependencies already satisfied, skipping bundle install"
fi

case "${1:-all}" in
  "rspec"|"specs"|"tests")
    echo "ğŸ§ª Running RSpec tests..."
    bundle exec rspec "${@:2}"
    ;;
  "rspec-no-system"|"specs-no-system"|"tests-no-system")
    echo "ğŸ§ª Running RSpec tests (excluding system tests)..."
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb" "${@:2}"
    ;;
  "system"|"system-tests")
    echo "ğŸ§ª Running system tests only..."
    echo "ğŸ” Pre-flight checks..."
    
    # Check Chrome wrapper
    echo "Testing Chrome wrapper:"
    if [ -f "/app/chrome_wrapper.sh" ]; then
      echo "âœ… Chrome wrapper found at /app/chrome_wrapper.sh"
      ls -la /app/chrome_wrapper.sh
      
      # Test wrapper directly
      echo "Testing wrapper execution:"
      if timeout 30 /app/chrome_wrapper.sh --version > /tmp/wrapper-test.log 2>&1; then
        echo "âœ… Chrome wrapper test succeeded"
        cat /tmp/wrapper-test.log
      else
        echo "âŒ Chrome wrapper test failed"
        cat /tmp/wrapper-test.log || echo "No log available"
      fi
    else
      echo "âŒ Chrome wrapper not found at /app/chrome_wrapper.sh"
    fi
    
    # Check DISPLAY and Xvfb
    echo "DISPLAY environment: $DISPLAY"
    if [ "$DISPLAY" = ":99" ]; then
      echo "Checking Xvfb on display :99"
      if pgrep -x "Xvfb" > /dev/null; then
        echo "âœ… Xvfb is already running"
      else
        echo "Starting Xvfb for display :99"
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 3
        if pgrep -x "Xvfb" > /dev/null; then
          echo "âœ… Xvfb started successfully"
        else
          echo "âŒ Failed to start Xvfb"
        fi
      fi
    fi
    
    # Clear any old chrome logs
    rm -rf /tmp/chrome-logs
    mkdir -p /tmp/chrome-logs
    
    echo "ğŸ§ª Starting system tests..."
    # If specific files are provided as additional arguments, run those; otherwise run all system tests
    if [ $# -gt 1 ]; then
      echo "Running specific system tests: ${@:2}"
      bundle exec rspec --format documentation "${@:2}"
    else
      echo "Running all system tests in spec/systems/"
      bundle exec rspec spec/systems/ --format documentation
    fi
    ;;
  "system-force"|"system-tests-force")
    echo "ğŸ§ª Running system tests (forced, ignoring Chrome check)..."
    # Clear any old chrome logs
    rm -rf /tmp/chrome-logs
    mkdir -p /tmp/chrome-logs
    
    bundle exec rspec spec/systems/ --format documentation "${@:2}"
    ;;
  "verify-chrome"|"chrome-check")
    echo "ğŸ” Checking Chrome installation..."
    echo "Chrome version:"
    google-chrome --version || echo "âŒ Chrome not found"
    echo "Chrome location:"
    which google-chrome || echo "âŒ Chrome not in PATH"
    echo "Chrome wrapper:"
    ls -la chrome_wrapper.sh || echo "âŒ Chrome wrapper not found"
    echo "Xvfb test:"
    Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    XVFB_PID=$!
    sleep 2
    if ps -p $XVFB_PID > /dev/null; then
      echo "âœ… Xvfb started successfully"
      echo "Testing Chrome wrapper with Xvfb:"
      DISPLAY=:99 timeout 30 ./chrome_wrapper.sh --version --headless > /dev/null 2>&1 && echo "âœ… Chrome wrapper works" || echo "âŒ Chrome wrapper failed"
      kill $XVFB_PID
    else
      echo "âŒ Xvfb failed to start"
    fi
    ;;
  "lint"|"linting")
    echo "ğŸ” Running StandardRB linting..."
    bundle exec standardrb "${@:2}"
    ;;
  "security"|"brakeman")
    echo "ğŸ”’ Running Brakeman security analysis..."
    bundle exec brakeman "${@:2}"
    ;;
  "audit")
    echo "ğŸ›¡ï¸ Running Bundle Audit..."
    bundle exec bundle-audit check --update
    ;;
  "junit")
    echo "ğŸ§ª Running RSpec tests with JUnit output..."
    bundle exec rspec --format RspecJunitFormatter --out tmp/rspec.xml --format progress "${@:2}"
    ;;
  "junit-no-system")
    echo "ğŸ§ª Running RSpec tests (excluding system tests) with JUnit output..."
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb" --format RspecJunitFormatter --out tmp/rspec.xml --format progress "${@:2}"
    ;;
  "all")
    echo "ğŸš€ Running all backend tests..."
    echo "ğŸ“ Running linting..."
    bundle exec standardrb
    echo "ğŸ”’ Running security analysis..."
    bundle exec brakeman
    echo "ğŸ›¡ï¸ Running audit..."
    bundle exec bundle-audit check --update
    echo "ğŸ§ª Running tests..."
    bundle exec rspec
    echo "âœ… All backend tests completed!"
    ;;
  "all-no-system")
    echo "ğŸš€ Running all backend tests (excluding system tests)..."
    echo "ğŸ“ Running linting..."
    bundle exec standardrb
    echo "ğŸ”’ Running security analysis..."
    bundle exec brakeman
    echo "ğŸ›¡ï¸ Running audit..."
    bundle exec bundle-audit check --update
    echo "ğŸ§ª Running tests (excluding system tests)..."
    bundle exec rspec --exclude-pattern="spec/systems/**/*_spec.rb"
    echo "âœ… All backend tests completed!"
    ;;
  "help"|"--help"|"-h")
    echo "Backend Test Runner"
    echo ""
    echo "Usage: ./bin/test [command] [options]"
    echo ""
    echo "Commands:"
    echo "  rspec, specs, tests      Run RSpec tests"
    echo "  rspec-no-system          Run RSpec tests excluding system tests"
    echo "  system, system-tests     Run system tests only (with Chrome check)"
    echo "  system-force             Run system tests (skip Chrome check)"
    echo "  verify-chrome, chrome-check  Verify Chrome installation"
    echo "  lint, linting           Run StandardRB linting"
    echo "  security, brakeman      Run Brakeman security analysis"
    echo "  audit                   Run Bundle Audit"
    echo "  junit                   Run RSpec with JUnit XML output"
    echo "  junit-no-system         Run RSpec (no system) with JUnit XML output"
    echo "  all                     Run all tests (default)"
    echo "  all-no-system           Run all tests excluding system tests"
    echo "  help                    Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./bin/test                           # Run all tests"
    echo "  ./bin/test all-no-system             # Run all tests except browser tests"
    echo "  ./bin/test rspec                     # Run all RSpec tests"
    echo "  ./bin/test rspec-no-system           # Run RSpec tests without browser tests"
    echo "  ./bin/test system                    # Run system/browser tests only"
    echo "  ./bin/test rspec spec/models/        # Run specific test directory"
    echo "  ./bin/test lint                      # Run linting only"
    echo "  ./bin/test security                  # Run security analysis only"
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo "Run './bin/test help' for usage information"
    exit 1
    ;;
esac
