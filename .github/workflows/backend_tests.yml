name: Backend Tests

on:
  push:
    paths:
      - 'backend/**'
      - '.github/workflows/backend_tests.yml'
      - 'docker-compose.test.yml'
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/backend_tests.yml'
      - 'docker-compose.test.yml'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure DNS for better connectivity
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf.backup > /dev/null
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf.backup > /dev/null  
        sudo cp /etc/resolv.conf.backup /etc/resolv.conf
        echo "ğŸ”§ DNS configuration updated"

    - name: Check network connectivity
      run: |
        echo "ğŸ” Checking network connectivity..."
        echo "Testing registry.npmjs.org:"
        curl -I https://registry.npmjs.org/ || echo "âŒ npm registry not reachable"
        echo "Testing github.com:"
        curl -I https://github.com/ || echo "âŒ GitHub not reachable"
        echo "Testing docker.io:"
        curl -I https://registry-1.docker.io/ || echo "âŒ Docker registry not reachable"
        echo "Testing rubygems.org:"
        curl -I https://rubygems.org/ || echo "âŒ RubyGems not reachable"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: image=moby/buildkit:buildx-stable-1
        buildkitd-flags: --allow-insecure-entitlement security.insecure

    - name: Generate cache keys
      id: cache-keys
      run: |
        # Generate content-based cache keys for better cache reuse
        echo "dockerfile-hash=$(sha256sum backend/Dockerfile | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "gemfile-hash=$(sha256sum backend/Gemfile backend/Gemfile.lock | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "ruby-version=$(cat backend/.ruby-version 2>/dev/null || echo '3.4.4')" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

    - name: Cache Docker buildx layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-backend-buildx-${{ steps.cache-keys.outputs.dockerfile-hash }}-${{ steps.cache-keys.outputs.gemfile-hash }}
        restore-keys: |
          ${{ runner.os }}-backend-buildx-${{ steps.cache-keys.outputs.dockerfile-hash }}-
          ${{ runner.os }}-backend-buildx-
          ${{ runner.os }}-buildx-

    - name: Cache Ruby dependencies
      uses: actions/cache@v4
      with:
        path: |
          /tmp/.bundle-cache
          backend/vendor/bundle
        key: ${{ runner.os }}-ruby-${{ steps.cache-keys.outputs.ruby-version }}-${{ steps.cache-keys.outputs.gemfile-hash }}
        restore-keys: |
          ${{ runner.os }}-ruby-${{ steps.cache-keys.outputs.ruby-version }}-
          ${{ runner.os }}-ruby-

    - name: Warm Docker cache with base images
      run: |
        # Pre-pull base images to warm the cache
        echo "ğŸ”¥ Warming cache with base images..."
        docker pull ruby:3.4.4-bullseye || echo "Could not pre-pull Ruby base image"
        docker pull postgis/postgis:15-3.3 || echo "Could not pre-pull PostGIS image"
        
        # Show current cache status
        echo "ğŸ“Š Current cache status:"
        du -sh /tmp/.buildx-cache 2>/dev/null || echo "No existing cache found"

    - name: Build backend test image with enhanced caching
      run: |
        # Retry Docker build up to 3 times in case of network issues
        for i in {1..3}; do
          echo "Build attempt $i of 3"
          if docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-from=type=gha \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --cache-to=type=gha,mode=max \
            --target test \
            --tag resilienceatlas-backend:test \
            --load \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            ./backend; then
            echo "âœ… Build successful on attempt $i"
            break
          elif [ $i -eq 3 ]; then
            echo "âŒ Build failed after 3 attempts"
            exit 1
          else
            echo "âš ï¸ Build attempt $i failed, retrying in 30 seconds..."
            sleep 30
          fi
        done

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Report cache analytics
      run: |
        echo "ğŸ“Š Cache analytics:"
        echo "Final cache size: $(du -sh /tmp/.buildx-cache 2>/dev/null || echo 'Unknown')"
        echo "Cache directory contents:"
        ls -la /tmp/.buildx-cache/ 2>/dev/null || echo "Cache directory not found"
        echo "Docker system info:"
        docker system df

    - name: Start test services
      run: |
        # Create test environment file
        cat > .env.test << EOF
        RAILS_ENV=test
        DATABASE_URL=postgres://postgres:postgres@db-test:5432/resilienceatlas_test
        DATABASE_HOST=db-test
        DATABASE_PORT=5432
        DATABASE_NAME=resilienceatlas_test
        DATABASE_USER=postgres
        DATABASE_PASSWORD=postgres
        SECRET_KEY_BASE=test_secret_key_base_that_is_long_enough_for_rails_to_accept_it_properly
        DEVISE_KEY=test_devise_key_that_is_also_long_enough_for_the_application_to_work
        REDIS_URL=redis://redis-test:6379/0
        EOF
        
        # Start test database and services
        docker compose -f docker-compose.test.yml up -d db-test redis-test
        
        # Wait for database to be ready
        timeout 60s bash -c 'until docker compose -f docker-compose.test.yml exec -T db-test pg_isready -U postgres; do sleep 2; done'

    - name: Setup test database
      run: |
        # Ensure tmp directory exists for test results
        mkdir -p backend/tmp
        
        # Setup database with proper error handling
        echo "Setting up test database..."
        docker compose -f docker-compose.test.yml run --rm backend-test \
          bash -c "
            echo 'Setting Rails environment...'
            RAILS_ENV=test bundle exec rails db:environment:set RAILS_ENV=test || true
            
            echo 'Preparing test database...'
            RAILS_ENV=test bundle exec rails db:prepare
            
            echo 'Verifying database setup...'
            RAILS_ENV=test bundle exec rails runner 'puts \"Database ready with #{ActiveRecord::Base.connection.tables.count} tables\"'
          " || {
            echo "âŒ Database setup failed, checking logs..."
            docker compose -f docker-compose.test.yml logs db-test --tail=20
            exit 1
          }

    - name: Run RSpec tests
      run: |
        echo "Running RSpec tests with enhanced error handling..."
        docker compose -f docker-compose.test.yml run --rm backend-test \
          bash -c "
            echo 'Verifying test environment...'
            bundle exec rails runner 'puts \"Rails #{Rails.version}, Ruby #{RUBY_VERSION}, Environment: #{Rails.env}\"'
            
            echo 'Starting RSpec tests...'
            ./bin/test junit
          " || {
            echo "âŒ RSpec tests failed, collecting debug information..."
            echo "Backend container logs:"
            docker compose -f docker-compose.test.yml logs backend-test --tail=100
            echo "Database container logs:"
            docker compose -f docker-compose.test.yml logs db-test --tail=50
            exit 1
          }

    - name: Run RuboCop linting
      run: |
        docker compose -f docker-compose.test.yml run --rm backend-test \
          bash -c "./bin/test lint"

    - name: Run Brakeman security analysis
      run: |
        docker compose -f docker-compose.test.yml run --rm backend-test \
          bash -c "./bin/test security"

    - name: Run Bundle Audit
      run: |
        docker compose -f docker-compose.test.yml run --rm backend-test \
          bash -c "./bin/test audit"

    - name: Verify test results
      run: |
        if [ -f backend/tmp/rspec.xml ]; then
          echo "Test results file found at backend/tmp/rspec.xml"
          ls -la backend/tmp/
        else
          echo "Test results file not found at backend/tmp/rspec.xml"
          echo "Contents of backend/tmp directory:"
          ls -la backend/tmp/ || echo "backend/tmp directory does not exist"
          exit 1
        fi

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Backend RSpec Tests
        path: backend/tmp/rspec.xml
        reporter: java-junit

    - name: Upload coverage reports
      if: always()
      run: |
        if docker compose -f docker-compose.test.yml run --rm backend-test test -f coverage/coverage.json; then
          docker compose -f docker-compose.test.yml run --rm backend-test \
            bash -c "cat coverage/coverage.json"
        fi

    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.test.yml down -v
        docker system prune -f
