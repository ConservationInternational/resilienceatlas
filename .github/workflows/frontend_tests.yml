name: Frontend Tests

on:
  push:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_tests.yml'
      - 'docker-compose.test.yml'
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_tests.yml'
      - 'docker-compose.test.yml'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: image=moby/buildkit:buildx-stable-1

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-frontend-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-frontend-buildx-

    - name: Build frontend test image
      run: |
        docker buildx build \
          --cache-from=type=local,src=/tmp/.buildx-cache \
          --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
          --target test \
          --build-arg NEXT_PUBLIC_API_HOST=http://localhost:3001 \
          --build-arg NEXT_PUBLIC_GOOGLE_ANALYTICS=GA_TEST_ID \
          --build-arg NEXT_PUBLIC_TRANSIFEX_TOKEN=test_token \
          --build-arg NEXT_PUBLIC_TRANSIFEX_SECRET=test_secret \
          --build-arg NEXT_PUBLIC_GOOGLE_API_KEY=test_api_key \
          --tag resilienceatlas-frontend:test \
          --load \
          ./frontend

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Create test environment
      run: |
        cat > .env.test << EOF
        NODE_ENV=test
        NEXT_PUBLIC_API_HOST=http://localhost:3001
        NEXT_PUBLIC_GOOGLE_ANALYTICS=GA_TEST_ID
        NEXT_PUBLIC_TRANSIFEX_TOKEN=test_token
        NEXT_PUBLIC_TRANSIFEX_SECRET=test_secret
        NEXT_PUBLIC_GOOGLE_API_KEY=test_api_key
        PORT=3000
        EOF

    - name: Run Jest unit tests
      run: |
        docker compose -f docker-compose.test.yml run --rm --no-deps frontend-test ./bin/test junit

    - name: Run ESLint
      run: |
        docker compose -f docker-compose.test.yml run --rm --no-deps frontend-test ./bin/test lint

    - name: Run TypeScript check
      run: |
        docker compose -f docker-compose.test.yml run --rm --no-deps frontend-test ./bin/test type-check

    - name: Build application
      run: |
        docker compose -f docker-compose.test.yml run --rm --no-deps frontend-test ./bin/test build

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Frontend Tests
        path: |
          frontend/jest-results.xml
        reporter: java-junit

    - name: Upload coverage reports
      if: always()
      run: |
        if docker compose -f docker-compose.test.yml run --rm frontend-test test -f coverage/lcov.info; then
          echo "Coverage report found"
        fi

    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.test.yml down -v
        docker system prune -f
